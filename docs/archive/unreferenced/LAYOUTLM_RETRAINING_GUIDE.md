# LayoutLM Model Retraining Guide

This guide walks you through retraining the LayoutLM model after adding new receipts to your dataset.

## Overview

The training workflow uses:
- **Auto Scaling Group (ASG)**: Manages EC2 GPU instances (starts at 0, scales up when needed)
- **S3 Bucket**: Stores training wheels, models, and artifacts
- **EC2 GPU Instance**: Runs the actual training (g5.xlarge with A10G GPU)
- **CLI Tool**: `layoutlm-cli train` command to start training

The model automatically syncs to S3 when training completes (if `--output-s3-path` is configured).

## Prerequisites

- AWS credentials configured (`~/.aws/credentials` or environment variables)
- SSH key `Nov2025MacBookPro.pem` in `~/` directory
- Pulumi stack deployed (infrastructure already set up)

## Step-by-Step Process

### Step 1: Build and Upload Wheels to S3

The easiest way is to use the deployment script:

```bash
# From repo root
./scripts/deploy_layoutlm_cli.sh
```

This script will:
1. Get the S3 bucket name from Pulumi
2. Build Python wheels for `receipt_dynamo` and `receipt_layoutlm`
3. Upload wheels to S3
4. Show you the next steps

**Manual alternative** (if script doesn't work):

```bash
# Build wheels
cd receipt_dynamo
python3 -m build --wheel
cd ../receipt_layoutlm
python3 -m build --wheel

# Get bucket name and upload
cd ../infra
BUCKET=$(pulumi stack output layoutlm_training_bucket --stack dev)
cd ..

# Upload wheels
aws s3 cp receipt_dynamo/dist/*.whl s3://$BUCKET/wheels/
aws s3 cp receipt_layoutlm/dist/*.whl s3://$BUCKET/wheels/
```

### Step 2: Scale Up the Auto Scaling Group

Launch an EC2 instance by scaling the ASG to 1:

```bash
# Get ASG name for DEV stack
cd infra
ASG_NAME=$(pulumi stack output layoutlm_training_asg_name --stack dev)
cd ..

# The ASG name will be something like: layoutlm-asg-871b451
echo "ASG Name: $ASG_NAME"

# Scale to 1 instance
aws autoscaling set-desired-capacity \
  --auto-scaling-group-name $ASG_NAME \
  --desired-capacity 1 \
  --region us-east-1
```

**Note**: The ASG name is `layoutlm-asg-<suffix>` where the suffix is generated by Pulumi. For DEV, you can get it with the command above, or use it directly if you know it.

**Wait 2-3 minutes** for the instance to launch and initialize. You can check status in AWS Console or:

```bash
# Check instance status
aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $ASG_NAME \
  --region us-east-1 \
  --query 'AutoScalingGroups[0].Instances[*].[InstanceId,LifecycleState,HealthStatus]' \
  --output table
```

### Step 3: Get Instance IP and SSH In

```bash
# Get instance ID
INSTANCE_ID=$(aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $ASG_NAME \
  --region us-east-1 \
  --query 'AutoScalingGroups[0].Instances[0].InstanceId' \
  --output text)

# Get instance IP
INSTANCE_IP=$(aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --region us-east-1 \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text)

# SSH into instance
ssh -i ~/Nov2025MacBookPro.pem ubuntu@$INSTANCE_IP
```

**Note**: The instance uses the Deep Learning AMI, so the user is `ubuntu` (not `ec2-user`).

### Step 4: Update Wheels on EC2 Instance

Once SSH'd in, update the installed packages:

```bash
# Get bucket name
BUCKET=$(aws s3 ls | grep layoutlm | awk '{print $3}' | head -1)
echo "Using bucket: $BUCKET"

# Download latest wheels (to user directory, no sudo needed)
mkdir -p ~/wheels
aws s3 cp s3://$BUCKET/wheels/ ~/wheels/ --recursive

# Install/update ONLY the receipt packages (dependencies stay the same)
# Use --no-deps to avoid reinstalling torch, transformers, etc.
pip install --user --force-reinstall --no-deps ~/wheels/receipt_dynamo-*.whl
pip install --user --force-reinstall --no-deps ~/wheels/receipt_layoutlm-*.whl

# Verify installation
python3 -c "import receipt_dynamo; import receipt_layoutlm; print('âœ… OK')"
export PATH="$HOME/.local/bin:$PATH"
layoutlm-cli train --help | head -20
```

**Note**: Using `--no-deps` skips reinstalling dependencies (torch, transformers, etc.) which saves significant time. Only the receipt packages are updated.

### Step 5: Clean Up Old Training Runs (Optional)

Free up disk space by removing old training runs:

```bash
# Check disk usage
df -h /

# Remove old training runs (be careful - this deletes old models!)
sudo rm -rf /tmp/receipt_layoutlm/*

# Verify space is freed
df -h /
```

### Step 6: Set Environment Variables

```bash
# Get DynamoDB table name
export DYNAMO_TABLE_NAME=$(aws dynamodb list-tables \
  --query 'TableNames[?contains(@, `receipt`)]' \
  --output text | head -1)

# Get S3 bucket for model output
export LAYOUTLM_TRAINING_BUCKET=$(aws s3 ls | grep layoutlm | awk '{print $3}' | head -1)

# Verify
echo "DYNAMO_TABLE_NAME=$DYNAMO_TABLE_NAME"
echo "LAYOUTLM_TRAINING_BUCKET=$LAYOUTLM_TRAINING_BUCKET"
```

### Step 7: Start Training

Run the training command. The model will automatically sync to S3 when training completes.

**Recommended training command** (4-label setup matching SROIE):

```bash
# Set job name with timestamp
JOB=receipts-$(date +%F-%H%M)-4label-retrain

# Start training
layoutlm-cli train \
  --job-name "$JOB" \
  --dynamo-table "$DYNAMO_TABLE_NAME" \
  --output-s3-path "$LAYOUTLM_TRAINING_BUCKET" \
  --epochs 20 \
  --batch-size 64 \
  --lr 6e-5 \
  --warmup-ratio 0.2 \
  --label-smoothing 0.1 \
  --o-entity-ratio 2.0 \
  --merge-amounts \
  --merge-date-time \
  --merge-address-phone \
  --early-stopping-patience 5 \
  --allowed-label MERCHANT_NAME \
  --allowed-label DATE \
  --allowed-label ADDRESS \
  --allowed-label AMOUNT
```

**Alternative: Full label set** (if you want all labels):

```bash
JOB=receipts-$(date +%F-%H%M)-full-retrain

layoutlm-cli train \
  --job-name "$JOB" \
  --dynamo-table "$DYNAMO_TABLE_NAME" \
  --output-s3-path "$LAYOUTLM_TRAINING_BUCKET" \
  --epochs 20 \
  --batch-size 64 \
  --lr 6e-5 \
  --warmup-ratio 0.2 \
  --label-smoothing 0.1 \
  --o-entity-ratio 2.0 \
  --merge-amounts \
  --early-stopping-patience 5 \
  --allowed-label MERCHANT_NAME \
  --allowed-label PHONE_NUMBER \
  --allowed-label ADDRESS_LINE \
  --allowed-label DATE \
  --allowed-label TIME \
  --allowed-label PRODUCT_NAME \
  --allowed-label AMOUNT
```

### Step 8: Monitor Training

Training outputs are saved to `/tmp/receipt_layoutlm/$JOB/`. Monitor progress:

```bash
# Watch training state
tail -f /tmp/receipt_layoutlm/$JOB/trainer_state.json

# Check for log files
ls -lh /tmp/receipt_layoutlm/$JOB/

# Monitor GPU usage
watch -n 1 nvidia-smi
```

### Step 9: Verify S3 Upload (After Training Completes)

The model should automatically sync to S3 when training finishes. Verify:

```bash
# Check S3 for your model
aws s3 ls s3://$LAYOUTLM_TRAINING_BUCKET/runs/$JOB/

# Check for best checkpoint
aws s3 ls s3://$LAYOUTLM_TRAINING_BUCKET/runs/$JOB/best/
```

**If automatic sync didn't work**, manually sync:

```bash
# Sync entire run directory
/usr/bin/aws s3 sync /tmp/receipt_layoutlm/$JOB s3://$LAYOUTLM_TRAINING_BUCKET/runs/$JOB/

# Sync best checkpoint
if [ -f /tmp/receipt_layoutlm/$JOB/trainer_state.json ]; then
  BEST=$(python3 - <<'PY'
import json,sys
p=f"/tmp/receipt_layoutlm/{sys.argv[1]}/trainer_state.json"
with open(p) as f:
    data = json.load(f)
    print(data.get("best_model_checkpoint",""))
PY
"$JOB")
  if [ -n "$BEST" ]; then
    echo "Best checkpoint: $BEST"
    /usr/bin/aws s3 sync "$BEST" s3://$LAYOUTLM_TRAINING_BUCKET/runs/$JOB/best/
  fi
fi
```

### Step 10: Scale Down ASG (Save Costs)

When training is complete, scale the ASG back to 0 to stop the instance:

```bash
# From your local machine (not EC2)
cd infra
ASG_NAME=$(pulumi stack output layoutlm_training_asg_name --stack dev)
cd ..

aws autoscaling set-desired-capacity \
  --auto-scaling-group-name $ASG_NAME \
  --desired-capacity 0 \
  --region us-east-1
```

## Quick Reference Commands

### From Local Machine

```bash
# Build and upload wheels
./scripts/deploy_layoutlm_cli.sh

# Scale up ASG (DEV)
cd infra
ASG_NAME=$(pulumi stack output layoutlm_training_asg_name --stack dev)
cd ..
aws autoscaling set-desired-capacity --auto-scaling-group-name $ASG_NAME --desired-capacity 1 --region us-east-1

# Get instance IP
INSTANCE_ID=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $ASG_NAME --region us-east-1 --query 'AutoScalingGroups[0].Instances[0].InstanceId' --output text)
INSTANCE_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --region us-east-1 --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
echo "ssh -i ~/Nov2025MacBookPro.pem ubuntu@$INSTANCE_IP"

# Scale down ASG
aws autoscaling set-desired-capacity --auto-scaling-group-name $ASG_NAME --desired-capacity 0 --region us-east-1
```

### On EC2 Instance

```bash
# Update wheels (fast - only updates receipt packages, keeps dependencies)
BUCKET=$(aws s3 ls | grep layoutlm | awk '{print $3}' | head -1)
mkdir -p ~/wheels
aws s3 cp s3://$BUCKET/wheels/ ~/wheels/ --recursive
pip install --user --force-reinstall --no-deps ~/wheels/receipt_dynamo-*.whl ~/wheels/receipt_layoutlm-*.whl
export PATH="$HOME/.local/bin:$PATH"

# Set environment
export DYNAMO_TABLE_NAME=$(aws dynamodb list-tables --query 'TableNames[?contains(@, `receipt`)]' --output text | head -1)
export LAYOUTLM_TRAINING_BUCKET=$(aws s3 ls | grep layoutlm | awk '{print $3}' | head -1)

# Train
JOB=receipts-$(date +%F-%H%M)-retrain
layoutlm-cli train --job-name "$JOB" --dynamo-table "$DYNAMO_TABLE_NAME" --output-s3-path "$LAYOUTLM_TRAINING_BUCKET" --epochs 20 --batch-size 64 --lr 6e-5 --warmup-ratio 0.2 --label-smoothing 0.1 --o-entity-ratio 2.0 --merge-amounts --merge-date-time --merge-address-phone --early-stopping-patience 5 --allowed-label MERCHANT_NAME --allowed-label DATE --allowed-label ADDRESS --allowed-label AMOUNT
```

## Troubleshooting

### Instance won't launch
- Check ASG events in CloudWatch
- Verify security group allows SSH (port 22)
- Check IAM role permissions
- Review user-data logs: `/var/log/cloud-init-output.log` (on instance)

### Wheels not installing
- Verify wheels are in `s3://$BUCKET/wheels/`
- Check IAM role has S3 read permissions
- Try: `sudo pip3 install --force-reinstall -v /opt/wheels/receipt_layoutlm-*.whl`

### Training fails immediately
- Verify DynamoDB table name: `echo $DYNAMO_TABLE_NAME`
- Check DynamoDB permissions: `aws dynamodb describe-table --table-name "$DYNAMO_TABLE_NAME"`
- Check GPU: `nvidia-smi`
- Check Python packages: `pip3 list | grep -E "(torch|transformers|receipt)"`

### Out of disk space
- Check usage: `df -h /`
- Find large files: `sudo du -sh /tmp/receipt_layoutlm/* | sort -h`
- Remove old runs: `sudo rm -rf /tmp/receipt_layoutlm/receipts-YYYY-MM-DD-*`

### Model didn't sync to S3
- Check if `--output-s3-path` was set
- Verify S3 permissions
- Manually sync (see Step 9)

## Next Steps

After training completes:
1. The model is in S3 at `s3://$BUCKET/runs/$JOB/best/`
2. The inference API will automatically discover the latest model
3. You can test the model using `layoutlm-cli infer` command

## Cost Optimization

- The ASG starts at 0 capacity (no cost when not training)
- Use spot instances (already configured) for ~70% cost savings
- Scale down to 0 immediately after training completes
- Training typically takes 2-4 hours depending on dataset size

