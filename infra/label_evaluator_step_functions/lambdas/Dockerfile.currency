# Currency Labels Evaluation Container Lambda
# Multi-stage build with LangSmith tracing support

# Stage 1: Build and install dependencies (cached layer)
FROM public.ecr.aws/lambda/python:3.12 AS dependencies

# Set environment variable to avoid hnswlib compilation issues
ENV HNSWLIB_NO_NATIVE=1

# Copy only the dependency packages (triggers rebuild only when these change)
COPY receipt_dynamo/ /tmp/receipt_dynamo/
COPY receipt_dynamo_stream/ /tmp/receipt_dynamo_stream/
COPY receipt_chroma/ /tmp/receipt_chroma/
COPY receipt_places/ /tmp/receipt_places/
COPY receipt_agent/ /tmp/receipt_agent/

# Install dependencies in correct order:
# 1. receipt_dynamo (base)
# 2. receipt_dynamo_stream (depends on receipt_dynamo)
# 3. receipt_chroma (depends on receipt_dynamo_stream)
# 4. receipt_places (depends on receipt_dynamo)
# 5. receipt_agent (depends on all above, brings langchain-ollama and langsmith)
RUN pip install --no-cache-dir /tmp/receipt_dynamo && \
    pip install --no-cache-dir /tmp/receipt_dynamo_stream && \
    pip install --no-cache-dir /tmp/receipt_chroma && \
    pip install --no-cache-dir /tmp/receipt_places && \
    pip install --no-cache-dir /tmp/receipt_agent && \
    rm -rf /tmp/receipt_dynamo /tmp/receipt_dynamo_stream /tmp/receipt_chroma /tmp/receipt_places /tmp/receipt_agent

# Stage 2: Copy Lambda-specific code (changes frequently)
FROM dependencies

# Copy the tracing utilities
COPY infra/label_evaluator_step_functions/lambdas/utils/tracing.py ${LAMBDA_TASK_ROOT}/tracing.py

# Copy the currency evaluation handler
COPY infra/label_evaluator_step_functions/lambdas/evaluate_currency_labels.py ${LAMBDA_TASK_ROOT}/handler.py

# Copy utils module
COPY infra/label_evaluator_step_functions/lambdas/utils/ ${LAMBDA_TASK_ROOT}/utils/

# Ensure files are readable (use shell glob instead of find which isn't in Lambda image)
RUN chmod 644 ${LAMBDA_TASK_ROOT}/tracing.py ${LAMBDA_TASK_ROOT}/handler.py && \
    chmod 644 ${LAMBDA_TASK_ROOT}/utils/*.py

# Set the handler
CMD ["handler.handler"]
