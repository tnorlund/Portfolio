name: Main CI/CD Pipeline
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Stage 1: Fast checks (fail fast)
  fast-checks:
    name: Format & Lint Checks
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      receipt_dynamo_changed: ${{ steps.changes.outputs.receipt_dynamo }}
      receipt_label_changed: ${{ steps.changes.outputs.receipt_label }}
      portfolio_changed: ${{ steps.changes.outputs.portfolio }}
      infra_changed: ${{ steps.changes.outputs.infra }}
      any_code_changed: ${{ steps.changes.outputs.all_code }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Need full history for change detection
      
      - name: Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            receipt_dynamo:
              - 'receipt_dynamo/**'
              - 'conftest.py'
              - 'pytest*.ini'
            receipt_label:
              - 'receipt_label/**'
              - 'conftest.py'
              - 'pytest*.ini'
            infra:
              - 'infra/**'
            portfolio:
              - 'portfolio/**'
            scripts:
              - 'scripts/**'
            workflows:
              - '.github/workflows/**'
            all_code:
              - '**/*.py'
              - '**/*.js'
              - '**/*.ts'
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install minimal dependencies
        run: |
          pip install black isort
      
      - name: Check Python formatting
        run: |
          # Check formatting but don't block (we have auto-format on PRs)
          echo "Checking Python formatting..."
          black --check receipt_dynamo receipt_label infra || echo "::warning::Some files need black formatting"
          isort --check-only receipt_dynamo receipt_label infra || echo "::warning::Some imports need isort formatting"
      
      - name: Set up Node.js
        if: steps.changes.outputs.portfolio == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'portfolio/package-lock.json'
      
      - name: Check TypeScript/ESLint
        if: steps.changes.outputs.portfolio == 'true'
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run lint
          npm run type-check

  # Stage 2: Tests (parallel)
  test-python:
    name: Python Tests (${{ matrix.package }}-${{ matrix.test_type }}${{ matrix.test_group && format('-{0}', matrix.test_group) || '' }})
    needs: fast-checks
    runs-on: ubuntu-latest
    if: |
      (matrix.package == 'receipt_dynamo' && needs.fast-checks.outputs.receipt_dynamo_changed == 'true') ||
      (matrix.package == 'receipt_label' && needs.fast-checks.outputs.receipt_label_changed == 'true') ||
      needs.fast-checks.outputs.workflows == 'true' ||
      github.event_name == 'schedule'
    strategy:
      matrix:
        include:
          # receipt_dynamo unit tests
          - package: receipt_dynamo
            test_type: unit
            test_path: tests/unit
          # Split receipt_dynamo integration tests into 4 parallel groups
          - package: receipt_dynamo
            test_type: integration
            test_group: group-1  
            test_path: tests/integration/test__receipt_word_label.py tests/integration/test__receipt.py tests/integration/test__receipt_validation_category.py tests/integration/test__geometry.py tests/integration/test__job_metric.py tests/integration/test__receipt_structure_analysis.py tests/integration/test__line.py tests/integration/test__receipt_line.py tests/integration/test__pulumi.py tests/integration/test__cluster.py
          - package: receipt_dynamo
            test_type: integration
            test_group: group-2
            test_path: tests/integration/test__receipt_field.py tests/integration/test__receipt_chatgpt_validation.py tests/integration/test__receipt_validation_summary.py tests/integration/test__gpt.py tests/integration/test__job_checkpoint.py tests/integration/test__word.py tests/integration/test__word_tag.py tests/integration/test__letter.py tests/integration/test__label_count_cache.py tests/integration/test_dynamo_client.py
          - package: receipt_dynamo
            test_type: integration
            test_group: group-3
            test_path: tests/integration/test__receipt_letter.py tests/integration/test__receipt_line_item_analysis.py tests/integration/test__queue.py tests/integration/test__instance.py tests/integration/test__receipt_word.py tests/integration/test__job_dependency.py tests/integration/test__ocr_job.py tests/integration/test__batch_summary.py tests/integration/test__receipt_section.py tests/integration/test__export_and_import.py
          - package: receipt_dynamo
            test_type: integration
            test_group: group-4
            test_path: tests/integration/test__receipt_validation_result.py tests/integration/test__receipt_label_analysis.py tests/integration/test__job.py tests/integration/test__job_resource.py tests/integration/test__image.py tests/integration/test__job_log.py tests/integration/test__places_cache.py tests/integration/test__receipt_word_tag.py tests/integration/test__ocr.py
          # receipt_label tests split by type
          - package: receipt_label
            test_type: unit
            test_path: tests/unit
          - package: receipt_label
            test_type: integration
            test_path: tests/integration
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache pip packages and virtual environment
        uses: actions/cache@v4  # Use latest cache action
        with:
          path: |
            ~/.cache/pip
            ${{ env.pythonLocation }}
            ~/.local/lib/python3.12/site-packages
            **/__pycache__
            .pytest_cache/pytest-results
          key: ${{ runner.os }}-python-v2-${{ matrix.package }}-${{ hashFiles(format('{0}/pyproject.toml', matrix.package), 'receipt_dynamo/pyproject.toml', 'conftest.py', 'pytest*.ini') }}
          restore-keys: |
            ${{ runner.os }}-python-v2-${{ matrix.package }}-
            ${{ runner.os }}-python-v2-
      
      - name: Cache pytest results and coverage
        uses: actions/cache@v4
        with:
          path: |
            ${{ matrix.package }}/.pytest_cache
            ${{ matrix.package }}/.coverage
            .pytest_cache
          key: ${{ runner.os }}-pytest-${{ matrix.package }}-${{ hashFiles(format('{0}/**/*.py', matrix.package)) }}
          restore-keys: |
            ${{ runner.os }}-pytest-${{ matrix.package }}-
      
      - name: Install package with optimizations
        run: |
          # Upgrade pip for faster installs
          python -m pip install --upgrade pip wheel --disable-pip-version-check
          
          # Check if packages are already cached
          if pip list | grep -q "pytest-xdist"; then
            echo "‚úì Test dependencies already cached"
          else
            echo "Installing test dependencies..."
            # Use parallel installs and disable version checks for speed
            pip install --no-deps pytest pytest-xdist pytest-timeout psutil moto boto3
            pip install pytest pytest-xdist pytest-timeout psutil moto boto3 --disable-pip-version-check
          fi
          
          # Install receipt_dynamo first as it's a dependency for other packages
          if [[ "${{ matrix.package }}" != "receipt_dynamo" ]]; then
            if pip list | grep -q "receipt-dynamo"; then
              echo "‚úì receipt_dynamo already cached"
            else
              pip install -e "receipt_dynamo[dev]" --no-deps
              pip install -e "receipt_dynamo[dev]"
            fi
          fi
          
          # Install the target package with minimal dependencies first
          if [[ "${{ matrix.package }}" == "receipt_trainer" ]] || [[ "${{ matrix.package }}" == "receipt_trainer_1" ]]; then
            pip install -e "${{ matrix.package }}[dev]"
          else
            # Check if already installed
            PACKAGE_NAME=$(echo "${{ matrix.package }}" | tr '_' '-')
            if pip list | grep -q "${PACKAGE_NAME}"; then
              echo "‚úì ${{ matrix.package }} already cached"
            else
              # Install with minimum dependencies first, then test extras
              pip install -e "${{ matrix.package }}" --no-deps
              pip install -e "${{ matrix.package }}[test]"
            fi
          fi
          
          # Verify installation
          echo "=== Key packages installed ==="
          pip list | grep -E "(pinecone|openai|receipt|pytest|moto|boto)" | head -10 || true
      
      - name: Run tests (${{ matrix.test_type }}${{ matrix.test_group && format('-{0}', matrix.test_group) || '' }})
        run: |
          # Use smart test runner that can skip unchanged tests
          echo "üîç Analyzing test dependencies and changes..."
          
          # First, try smart test selection (skip if no meaningful changes)
          python scripts/smart_test_runner.py \
            ${{ matrix.package }} \
            ${{ matrix.test_path }} \
            --dry-run
          
          # Then run with the optimized test runner
          python scripts/smart_test_runner.py \
            ${{ matrix.package }} \
            ${{ matrix.test_path }} || \
          python scripts/run_tests_optimized.py \
            ${{ matrix.package }} \
            ${{ matrix.test_path }} \
            --test-type ${{ matrix.test_type }} \
            --coverage \
            --timeout 600
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}-${{ matrix.test_type }}${{ matrix.test_group && format('-{0}', matrix.test_group) || '' }}
          path: ${{ matrix.package }}/coverage.xml
          retention-days: 1

  test-typescript:
    name: TypeScript Tests
    needs: fast-checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'portfolio/package-lock.json'
      
      - name: Install and test
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run test:ci
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-portfolio
          path: portfolio/coverage
          retention-days: 1

  # Stage 3: Documentation (can run in parallel with tests)
  docs:
    name: Generate Documentation
    needs: fast-checks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    continue-on-error: true  # Don't fail the whole workflow if docs fail
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'portfolio/package-lock.json'
      
      - name: Generate docs
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run docs
      
      - name: Commit documentation
        continue-on-error: true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs: update TypeDoc documentation [skip ci]'
          file_pattern: 'portfolio/docs/**'
          skip_dirty_check: false
          skip_checkout: true

  # Stage 4: Deploy (only on main)
  deploy:
    name: Deploy with Pulumi
    needs: [test-python, test-typescript]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'portfolio/package-lock.json'
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Build Next.js app
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run build
      
      - name: Install Python dependencies
        run: |
          pip install -r infra/requirements.txt
      
      - name: Deploy with Pulumi
        run: |
          cd infra
          pulumi stack select tnorlund/portfolio/prod
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      
      - name: Get Pulumi outputs
        id: pulumi-outputs
        run: |
          cd infra
          echo "bucket_name=$(pulumi stack output site_bucket_name)" >> $GITHUB_OUTPUT
          echo "distribution_id=$(pulumi stack output distribution_id)" >> $GITHUB_OUTPUT
      
      - name: Sync to S3
        run: |
          aws s3 sync portfolio/out s3://${{ steps.pulumi-outputs.outputs.bucket_name }} \
            --delete \
            --cache-control "public, max-age=3600"
      
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.pulumi-outputs.outputs.distribution_id }} \
            --paths "/*"

  # Stage 5: E2E tests (only after deploy)
  e2e-tests:
    name: End-to-End Tests
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install package
        run: |
          pip install -e "receipt_dynamo[test]"
      
      - name: Run E2E tests
        working-directory: receipt_dynamo
        run: |
          pytest -m end_to_end --tb=short
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

  # Summary job for branch protection
  ci-success:
    name: CI Success
    needs: [fast-checks, test-python, test-typescript]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.fast-checks.result }}" != "success" || 
                "${{ needs.test-python.result }}" != "success" || 
                "${{ needs.test-typescript.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"