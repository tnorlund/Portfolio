name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONPATH: ${{ github.workspace }}

jobs:
  # ============================================================================
  # STAGE 1: All tests run in parallel
  # ============================================================================

  python-tests:
    name: Python (${{ matrix.package }})
    runs-on: [self-hosted, macOS, ARM64]
    strategy:
      fail-fast: false
      matrix:
        package: [receipt_dynamo, receipt_dynamo_stream, receipt_chroma, receipt_places]
    steps:
      - uses: actions/checkout@v6
        with:
          clean: true

      - name: Setup Python
        run: |
          if [ -f "/Library/Frameworks/Python.framework/Versions/3.12/bin/python3" ]; then
            echo "/Library/Frameworks/Python.framework/Versions/3.12/bin" >> $GITHUB_PATH
          elif [ -f "/opt/homebrew/bin/python3" ]; then
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          fi

      - name: Install and test
        run: |
          # Create fresh virtual environment
          python3 -m venv .venv-${{ matrix.package }}
          source .venv-${{ matrix.package }}/bin/activate
          pip install --upgrade pip wheel

          # Install based on package dependencies
          case "${{ matrix.package }}" in
            receipt_chroma)
              pip install -e receipt_dynamo
              pip install --no-deps -e receipt_dynamo_stream
              pip install boto3
              pip install --no-deps -e receipt_chroma
              pip install boto3 chromadb "openai>=2.8.1,<3.0.0"
              pip install pytest pytest-mock pytest-cov pytest-xdist pytest-timeout moto
              ;;
            receipt_dynamo_stream)
              pip install -e receipt_dynamo
              pip install --no-deps -e receipt_dynamo_stream
              pip install boto3 pytest pytest-mock pytest-cov pytest-xdist pytest-timeout moto
              ;;
            receipt_places)
              pip install -e receipt_dynamo
              pip install --no-deps -e receipt_places
              pip install pydantic pydantic-settings structlog boto3 requests tenacity
              pip install pytest pytest-mock pytest-cov pytest-xdist pytest-timeout moto responses
              ;;
            *)
              pip install -e "${{ matrix.package }}[test]"
              ;;
          esac

          # Lint
          pip install black isort
          black --check --line-length=79 ${{ matrix.package }} || echo "::warning::Formatting issues"
          isort --check-only ${{ matrix.package }} || echo "::warning::Import order issues"

          # Test
          cd ${{ matrix.package }}
          python -m pytest tests -n auto --timeout=120 --tb=short --maxfail=5 \
            -m "not end_to_end and not slow and not performance" \
            --cov --cov-report=xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: ${{ matrix.package }}/coverage.xml
          retention-days: 1

  typescript-tests:
    name: TypeScript
    runs-on: [self-hosted, macOS, ARM64]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Lint and test
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run lint
          npm run type-check
          npm run test:ci

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-portfolio
          path: portfolio/coverage
          retention-days: 1

  browser-tests:
    name: Browser Tests
    runs-on: [self-hosted, macOS, ARM64]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Build and test
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run build

          # Start server and run tests
          npx serve out -l 3000 &
          sleep 3

          npx playwright install chromium firefox webkit
          PLAYWRIGHT_BASE_URL=http://localhost:3000 npx playwright test e2e/hydration.spec.ts \
            --project=chromium --project=firefox --project=webkit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: portfolio/playwright-report/
          retention-days: 7

  # ============================================================================
  # STAGE 2: Deploy (only after ALL tests pass, main branch only)
  # ============================================================================

  deploy:
    name: Deploy
    needs: [python-tests, typescript-tests, browser-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "portfolio/package-lock.json"

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - uses: docker/setup-buildx-action@v3

      - name: Build portfolio
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run build

      - name: Deploy infrastructure
        run: |
          cd infra
          pip install -e .
          pulumi stack select tnorlund/portfolio/prod
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Deploy to S3 + CloudFront
        run: |
          cd infra
          BUCKET=$(pulumi stack output cdn_bucket_name)
          DIST_ID=$(pulumi stack output cdn_distribution_id)

          aws s3 sync ../portfolio/out s3://$BUCKET --delete --cache-control "public, max-age=3600"
          aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"

  # ============================================================================
  # STAGE 3: Post-deploy smoke tests
  # ============================================================================

  smoke-tests:
    name: Smoke Tests
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Run backend E2E tests
        run: |
          pip install -e "receipt_dynamo[test]"
          cd receipt_dynamo
          pytest -m end_to_end --timeout=600 --tb=short
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ============================================================================
  # Docs (runs on main, doesn't block anything)
  # ============================================================================

  docs:
    name: Generate Docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "portfolio/package-lock.json"

      - name: Generate and commit docs
        working-directory: portfolio
        run: |
          npm ci --prefer-offline
          npm run docs

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update TypeDoc documentation [skip ci]"
          file_pattern: "portfolio/docs/**"
